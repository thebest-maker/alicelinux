#make defconfig
#sed -i "s/# CONFIG_STATIC .*/CONFIG_STATIC=y/" .config

#for o in LINUXRC STRINGS XZ UNXZ XZCAT LZCAT UNLZMA LZMA PATCH BZIP2 BZCAT BUNZIP2; do
#	sed -i "s/CONFIG_${o}=y/# CONFIG_${o} is not set/" .config
#done

#sed -i "s/^CONFIG_MODPROBE_SMALL*/# CONFIG_MODPROBE_SMALL is not set/" .config

cp $SRC/config .config
#make menuconfig
make
make CONFIG_PREFIX=$PKG install
mkdir -p $PKG/usr/share/busybox
cat .config > $PKG/usr/share/busybox/config

BIN="$BIN xzcat xz unxz unlzma lzcat lzma" #xz
#BIN="$BIN zcat gunzip gzip" #gzip
BIN="$BIN strings" #binutils
BIN="$BIN clear reset" #ncurses
BIN="$BIN patch" #patch
BIN="$BIN bzcat bunzip2 bzip2" #bzip2
BIN="$BIN setfattr" #attr
BIN="$BIN chattr lsattr mke2fs findfs mkfs.ext2 blkid" #e2fsprogs
BIN="$BIN mkdosfs mkfs.vfat " #dosfstools

# XXX
for i in $BIN; do
	rm $PKG/*/$i || true
	rm $PKG/*/*/$i || true
done

cp $PKG/bin/busybox $PKG/bin/busybox-suid
chmod u+s $PKG/bin/busybox-suid

for a in bin/mount \
	bin/umount \
	bin/su \
	bin/ping ; do
	rm $PKG/$a
	ln -sv busybox-suid $PKG/$a
done

for a in usr/bin/crontab \
	usr/bin/passwd \
	usr/bin/traceroute \
	usr/bin/traceroute6 \
	usr/bin/vlock; do
	rm $PKG/$a
	ln -sv ../../bin/busybox-suid $PKG/$a
done

mkdir -p $PKG/etc
install -m644 $SRC/mdev.conf $PKG/etc/mdev.conf

rm $PKG/usr/bin/diff
ln -s busybox $PKG/bin/diff
